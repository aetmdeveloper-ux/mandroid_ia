<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MANDROID.IA — Sistema de Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
  <style>
    /* ── Variáveis e Reset ──────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --neon-green:      #00ff41;
      --neon-cyan:       #00e5ff;
      --dark-bg:         #000800;
      --panel-bg:        rgba(0, 15, 0, 0.95);
      --msg-user-bg:     rgba(0, 40, 20, 0.8);
      --msg-ai-bg:       rgba(0, 20, 40, 0.8);
      --border:          rgba(0, 255, 65, 0.25);
      --text-main:       #e0ffe0;
    }

    body {
      background: var(--dark-bg);
      color: var(--text-main);
      font-family: 'Rajdhani', sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* Matrix Rain de fundo */
    #matrix-canvas { position: fixed; inset: 0; opacity: 0.15; z-index: 0; }

    .app-container {
      position: relative; z-index: 1;
      display: flex; flex-direction: column;
      height: 100vh; max-width: 1000px; margin: 0 auto; padding: 10px;
    }

    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px; border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .brand { font-family: 'Orbitron', sans-serif; letter-spacing: 3px; color: var(--neon-green); font-weight: 700; }

    /* Chat Area */
    .chat-box {
      flex: 1; overflow-y: auto; padding: 20px 10px;
      display: flex; flex-direction: column; gap: 20px;
    }
    
    .message { max-width: 85%; padding: 12px 16px; border-radius: 8px; line-height: 1.6; font-size: 1rem; position: relative; }
    .user-msg { align-self: flex-end; background: var(--msg-user-bg); border-right: 3px solid var(--neon-cyan); }
    .ai-msg { align-self: flex-start; background: var(--msg-ai-bg); border-left: 3px solid var(--neon-green); }

    /* Sugestões Contextuais */
    .suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .sug-btn {
      background: rgba(0, 255, 65, 0.1); border: 1px solid var(--border);
      color: var(--neon-green); padding: 6px 12px; border-radius: 20px;
      font-size: 0.85rem; cursor: pointer; transition: 0.2s;
    }
    .sug-btn:hover { background: var(--neon-green); color: black; }

    /* Input Area */
    .input-area { padding: 15px; background: var(--panel-bg); border-radius: 12px; border: 1px solid var(--border); }
    .input-form { display: flex; gap: 10px; }
    textarea {
      flex: 1; background: transparent; border: none; color: white;
      resize: none; outline: none; font-size: 1rem; font-family: inherit;
    }
    .send-btn { background: var(--neon-green); border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }

    /* Scrollbar Custom */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border); }
  </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="app-container">
  <header class="header">
    <div class="brand">MANDROID.IA</div>
    <div style="display:flex; gap:10px;">
      <button onclick="clearChat()" style="background:transparent; color:#00e5ff; border:1px solid #00e5ff; padding:5px 10px; cursor:pointer; border-radius:4px;">LIMPAR</button>
      <button onclick="window.location.href='/auth/logout'" style="background:transparent; color:#ff4444; border:1px solid #ff4444; padding:5px 10px; cursor:pointer; border-radius:4px;">SAIR</button>
    </div>
  </header>

  <main class="chat-box" id="chat-box">
    <div class="message ai-msg">
      MANDROID.IA online. Como posso auxiliar em seu projeto hoje?
    </div>
  </main>

  <footer class="input-area">
    <form class="input-form" onsubmit="event.preventDefault(); sendMessage();">
      <textarea id="user-input" placeholder="Digite sua mensagem ou comando..." rows="1"></textarea>
      <button type="submit" class="send-btn">ENVIAR</button>
    </form>
  </footer>
</div>

<script>
  // Matrix Effect
  const canvas = document.getElementById('matrix-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const drops = new Array(Math.floor(canvas.width/20)).fill(1);
  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 8, 0, 0.1)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#00ff41";
    drops.forEach((y, i) => {
      ctx.fillText(Math.floor(Math.random()*2), i*20, y*20);
      if (y*20 > canvas.height && Math.random() > 0.98) drops[i] = 0;
      drops[i]++;
    });
  }
  setInterval(drawMatrix, 50);

  const chatBox = document.getElementById('chat-box');
  const userInput = document.getElementById('user-input');

  async function sendMessage(text = null) {
    const message = text || userInput.value.trim();
    if (!message) return;

    // Adiciona mensagem do usuário
    appendMessage(message, 'user-msg');
    userInput.value = '';

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await response.json();
      
      // Adiciona resposta da IA e sugestões
      appendMessage(data.response, 'ai-msg', data.suggestions);
    } catch (e) {
      appendMessage("Erro na comunicação com o servidor.", 'ai-msg');
    }
  }

  function appendMessage(text, className, suggestions = []) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${className}`;
    msgDiv.innerText = text;
    chatBox.appendChild(msgDiv);

    if (suggestions && suggestions.length > 0) {
      const sugContainer = document.createElement('div');
      sugContainer.className = 'suggestions';
      suggestions.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'sug-btn';
        btn.innerText = s;
        btn.onclick = () => sendMessage(s);
        sugContainer.appendChild(btn);
      });
      chatBox.appendChild(sugContainer);
    }
    
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function clearChat() {
    await fetch('/api/clear', { method: 'POST' });
    chatBox.innerHTML = '<div class="message ai-msg">Histórico limpo. MANDROID.IA pronto para novas instruções.</div>';
  }

  // Ajuste automático do textarea
  userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
</script>
</body>
</html>
