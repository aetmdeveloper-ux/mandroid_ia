<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MANDROID.IA ‚Äî Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>
  <style>
    /* ‚îÄ‚îÄ Reset & Variables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --neon-green:      #00ff41;
      --neon-cyan:       #00e5ff;
      --neon-purple:     #bf00ff;
      --neon-blue:       #0044ff;
      --neon-yellow:     #ffff00;
      --dark-bg:         #000800;
      --panel-bg:        rgba(0, 12, 0, 0.92);
      --input-bg:        rgba(0, 20, 0, 0.9);
      --msg-user-bg:     rgba(0, 60, 20, 0.6);
      --msg-ai-bg:       rgba(0, 20, 50, 0.7);
      --border:          rgba(0, 255, 65, 0.3);
      --border-hover:    rgba(0, 255, 65, 0.7);
      --text-primary:    #e0ffe0;
      --text-secondary:  rgba(0,229,255,0.7);
      --scrollbar-track: rgba(0,15,0,0.5);
      --scrollbar-thumb: rgba(0,255,65,0.3);
      --header-h:        70px;
      --footer-h:        80px;
    }

    html, body {
      width: 100%; height: 100%;
      background: var(--dark-bg);
      overflow: hidden;
      font-family: 'Rajdhani', sans-serif;
      color: var(--text-primary);
    }

    #matrix-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      opacity: 0.18;
    }

    .app-wrapper {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .app-header {
      flex-shrink: 0;
      height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,8,0,0.95);
      backdrop-filter: blur(20px);
      padding: 0 8px;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 30px rgba(0,255,65,0.08);
    }

    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo { width: 44px; height: 44px; filter: drop-shadow(0 0 8px var(--neon-green)); animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

    .header-title {
      font-family: 'Orbitron', monospace;
      font-size: clamp(1rem, 2.5vw, 1.6rem);
      font-weight: 900;
      letter-spacing: 4px;
      background: linear-gradient(135deg, #00ff41, #00e5ff, #bf00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 2.5s ease-in-out infinite alternate;
    }

    @keyframes titleGlow { from { filter: drop-shadow(0 0 4px #00ff41); } to { filter: drop-shadow(0 0 14px #00e5ff); } }

    .status-badge { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--neon-green); font-family: 'Share Tech Mono', monospace; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    .header-user { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--neon-green); }
    .user-avatar-placeholder { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--neon-green); display: flex; align-items: center; justify-content: center; color: var(--neon-green); }

    .btn-header { display: flex; align-items: center; gap: 6px; padding: 7px 14px; background: transparent; border: 1px solid; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: 600; transition: all 0.25s ease; }
    .btn-clear { border-color: rgba(0,229,255,0.4); color: var(--neon-cyan); }
    .btn-clear:hover { background: rgba(0,229,255,0.1); border-color: var(--neon-cyan); }
    .btn-exit { border-color: rgba(255,60,60,0.4); color: #ff6b6b; }
    .btn-exit:hover { background: rgba(255,60,60,0.1); border-color: #ff4444; }

    .chat-area { flex: 1; display: flex; flex-direction: column; gap: 12px; overflow: hidden; padding: 16px 0 8px; }
    .response-panel { flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 14px; padding: 16px; overflow-y: auto; backdrop-filter: blur(20px); }
    
    /* Mensagens */
    .message-list { display: flex; flex-direction: column; gap: 16px; }
    .message-item { display: flex; gap: 12px; animation: msgAppear 0.35s ease-out; }
    @keyframes msgAppear { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; } }
    .user-msg { justify-content: flex-end; }
    .msg-bubble { max-width: 78%; padding: 14px 18px; border-radius: 12px; font-size: 0.96rem; line-height: 1.6; }
    .user-msg .msg-bubble { background: var(--msg-user-bg); border: 1px solid rgba(0,229,255,0.3); border-radius: 12px 2px 12px 12px; }
    .ai-msg .msg-bubble { background: var(--msg-ai-bg); border: 1px solid rgba(0,255,65,0.25); border-radius: 2px 12px 12px 12px; }
    .msg-avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1.5px solid; }

    /* Input Panel */
    .input-panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    .input-form { display: flex; gap: 10px; align-items: flex-end; }
    .input-textarea { flex: 1; background: var(--input-bg); border: 1px solid rgba(0,255,65,0.2); border-radius: 10px; padding: 12px; color: white; resize: none; outline: none; }
    .btn-send { width: 50px; height: 50px; border-radius: 10px; border: 2px solid var(--neon-green); background: rgba(0,255,65,0.1); color: var(--neon-green); cursor: pointer; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: #000c00; border: 1px solid var(--neon-green); padding: 30px; border-radius: 16px; text-align: center; width: 400px; }
    .modal-btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: 2px solid; margin: 5px; font-weight: bold; }
    .modal-btn-confirm { border-color: #ff4444; color: #ff4444; background: transparent; }
    .modal-btn-cancel { border-color: var(--neon-green); color: var(--neon-green); background: transparent; }

    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #001500; border: 1px solid var(--neon-green); padding: 12px 24px; color: var(--neon-green); border-radius: 8px; transition: 0.3s; z-index: 200; }
    .toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="app-wrapper">
  <header class="app-header">
    <div class="header-brand">
      <div class="header-title">MANDROID.IA</div>
    </div>
    <div style="display:flex; align-items:center; gap:16px;">
      <div class="status-badge"><div class="status-dot"></div><span>ONLINE</span></div>
      <div class="header-user" id="user-info">
        <div class="user-avatar-placeholder">üë§</div>
        <span class="user-name" id="user-display-name">Carregando...</span>
      </div>
      <button class="btn-header btn-clear" onclick="showModal('clear')"><span>üóë</span><span>LIMPAR</span></button>
      <button class="btn-header btn-exit" onclick="showModal('exit')"><span>‚èª</span><span>SAIR</span></button>
    </div>
  </header>

  <div class="chat-area">
    <div class="response-panel" id="response-panel">
      <div class="message-list" id="message-list">
        <div class="welcome-msg" id="welcome-msg" style="text-align:center; padding:40px; opacity:0.5;">
          ü§ñ MANDROID.IA ONLINE<br>Como posso ajudar hoje?
        </div>
      </div>
    </div>

    <div class="input-panel">
      <form class="input-form" id="chat-form" onsubmit="return false;">
        <textarea class="input-textarea" id="user-input" placeholder="Digite aqui..." rows="1"></textarea>
        <button class="btn-send" id="send-btn">‚û§</button>
      </form>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box">
    <h2 id="modal-title" style="color:var(--neon-cyan); margin-bottom:15px;">CONFIRMAR</h2>
    <p id="modal-text" style="margin-bottom:20px;">Tem certeza?</p>
    <button class="modal-btn modal-btn-cancel" onclick="hideModal()">CANCELAR</button>
    <button class="modal-btn modal-btn-confirm" onclick="confirmAction()">SIM, CONFIRMAR</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // MATRIX BACKGROUND
  const canvas = document.getElementById('matrix-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const chars = "01MANDROIDIA";
  const drops = new Array(Math.floor(canvas.width/15)).fill(1);
  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 8, 0, 0.05)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#00ff41"; ctx.font = "15px monospace";
    drops.forEach((y, i) => {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * 15, y * 15);
      if (y * 15 > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    });
  }
  setInterval(drawMatrix, 50);

  // USER LOGIC
  let currentUser = null;
  async function loadUser() {
    try {
      const res = await fetch('/api/user');
      const data = await res.json();
      if (data.authenticated) {
        currentUser = data.user;
        document.getElementById('user-display-name').textContent = data.user.name;
      } else { window.location.href = '/'; }
    } catch(e) { console.log(e); }
  }
  loadUser();

  // MODAL LOGIC
  let currentAction = '';
  function showModal(action) {
    currentAction = action;
    document.getElementById('modal-overlay').classList.add('show');
    document.getElementById('modal-title').textContent = action === 'clear' ? 'LIMPAR CHAT' : 'SAIR';
    document.getElementById('modal-text').textContent = action === 'clear' ? 'Deseja apagar todo o hist√≥rico?' : 'Deseja encerrar sua sess√£o?';
  }
  function hideModal() { document.getElementById('modal-overlay').classList.remove('show'); }

  async function confirmAction() {
    if (currentAction === 'clear') {
      const res = await fetch('/api/clear', { method: 'POST' });
      if (res.ok) {
        document.getElementById('message-list').innerHTML = '';
        showToast("CHAT REINICIADO");
      }
    } else {
      window.location.href = '/auth/logout';
    }
    hideModal();
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  // CHAT LOGIC (Simplificada)
  const inputEl = document.getElementById('user-input');
  const listEl = document.getElementById('message-list');
  
  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;
    
    // User message
    const uDiv = document.createElement('div');
    uDiv.className = 'message-item user-msg';
    uDiv.innerHTML = `<div class="msg-bubble">${text}</div>`;
    listEl.appendChild(uDiv);
    inputEl.value = '';

    // Chamada para o servidor (Groq)
    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      
      const aDiv = document.createElement('div');
      aDiv.className = 'message-item ai-msg';
      aDiv.innerHTML = `<div class="msg-avatar">ü§ñ</div><div class="msg-bubble">${data.response}</div>`;
      listEl.appendChild(aDiv);
      document.getElementById('response-panel').scrollTop = document.getElementById('response-panel').scrollHeight;
    } catch(e) { showToast("ERRO NA CONEX√ÉO"); }
  }

  document.getElementById('send-btn').onclick = sendMessage;
  inputEl.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
</script>

</body>
</html>
